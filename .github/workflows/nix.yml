name: Nix CI

on:
  pull_request:
    branches:
      - main

jobs:
  check:
    name: Nix Check & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Check flake
        run: nix flake check --no-build

      - name: Check format
        run: |
          nix develop --command nixpkgs-fmt --check flake.nix home.nix home-ci.nix nix/

  build:
    name: Build Home Manager
    runs-on: ubuntu-latest
    needs: check
    steps:
      - name: Free disk space
        run: |
          echo "=== Before cleanup ==="
          df -h

          # Remove large unnecessary packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

          echo "=== After cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build CI Home Manager configuration
        run: nix build .#homeConfigurations.ci.activationPackage --no-link

      - name: Build full Home Manager configuration
        run: nix build .#homeConfigurations.archie.activationPackage --no-link

  verify:
    name: Verify Tools
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Free disk space
        run: |
          echo "=== Before cleanup ==="
          df -h

          # Remove large unnecessary packages
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force

          echo "=== After cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Build CI Home Manager configuration
        run: nix build .#homeConfigurations.ci.activationPackage

      - name: Activate Home Manager (CI profile)
        run: ./result/activate

      - name: Verify core tools
        run: |
          echo "=== Verifying installed tools ==="

          # Shell tools
          echo "Fish version:"
          fish --version

          echo "Starship version:"
          starship --version

          # Rust tools
          echo "Ripgrep version:"
          rg --version | head -1

          echo "fd version:"
          fd --version

          echo "bat version:"
          bat --version

          echo "eza version:"
          eza --version | head -1

          # Git tools
          echo "Git version:"
          git --version

          echo "Delta version:"
          delta --version

          echo "Lazygit version:"
          lazygit --version | head -1

          # Dev tools
          echo "Neovim version:"
          nvim --version | head -1

          echo "Tmux version:"
          tmux -V

          echo "=== All tools verified successfully ==="
