name: Nix CI

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'llm/**'
      - 'LICENSE'
      - '.gitignore'
  pull_request:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'llm/**'
      - 'LICENSE'
      - '.gitignore'

jobs:
  # Build Docker image with Nix pre-installed
  build-image:
    name: Build Docker Image
    uses: ./.github/workflows/build-docker-image.yml
    permissions:
      contents: read
      packages: write

  # Check flake and formatting (lightweight, no container needed)
  check:
    name: Nix Check & Format
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main
        with:
          use-flakehub: false

      - name: Check flake
        run: nix flake check --no-build

      - name: Check format
        run: |
          nix develop --command nixpkgs-fmt --check flake.nix home.nix nix/

  # Build in Arch Linux container with Docker layer cache
  # This preserves the Arch Linux environment for testing
  # Note: We manually pull/run Docker instead of using `container:` section
  # because `container:` pulls the image BEFORE any steps run,
  # which prevents disk cleanup from running first.
  #
  # Strategy: Mount host's Nix store into container for cache sharing
  # - Host installs Nix and sets up nix-community/cache-nix-action
  # - Container uses host's /nix store via volume mount
  # - This enables Nix cache to persist across CI runs
  # Note: magic-nix-cache doesn't work well with Docker containers because
  # it subscribes to Nix daemon events on the host, not inside containers
  verify-docker:
    name: Build & Verify (Arch Linux)
    runs-on: ubuntu-latest
    needs: [build-image, check]
    steps:
      # Free up disk space BEFORE pulling the large Docker image
      - name: Free disk space
        run: |
          echo "=== Disk space before cleanup ==="
          df -h
          echo "=== Removing unnecessary tools ==="
          sudo rm -rf /usr/share/dotnet      # ~6GB
          sudo rm -rf /usr/local/lib/android # ~10GB
          sudo rm -rf /opt/ghc               # ~5GB
          sudo rm -rf /usr/share/swift       # ~1.5GB
          sudo rm -rf /usr/local/share/boost # ~1.5GB
          echo "=== Disk space after cleanup ==="
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      # Create /nix directory with proper permissions before cache restore
      # This is required because runner user cannot create /nix without sudo
      - name: Prepare Nix directory
        run: |
          sudo mkdir -p /nix
          sudo chown -R "$(whoami)":"$(whoami)" /nix

      # Restore Nix cache BEFORE installing Nix
      # This prevents conflicts between fresh Nix install and cached /nix store
      # Note: nix: false is required because Nix is not installed yet
      - name: Restore Nix cache
        id: nix-cache
        uses: nix-community/cache-nix-action@v6
        with:
          primary-key: nix-docker-${{ runner.os }}-${{ hashFiles('**/*.nix', 'flake.lock') }}
          restore-prefixes-first-match: nix-docker-${{ runner.os }}-
          paths: |
            /nix
            ~/.cache/nix
          nix: false

      # DEBUG: Inspect /nix directory after cache restore
      - name: Debug - Inspect /nix after cache restore
        if: steps.nix-cache.outputs.hit == 'true'
        run: |
          echo "=== Cache restore debug info ==="
          echo "Cache hit: ${{ steps.nix-cache.outputs.hit }}"
          echo ""
          echo "=== /nix top-level contents ==="
          ls -la /nix/ || echo "/nix does not exist"
          echo ""
          echo "=== /nix/var/nix/profiles contents ==="
          ls -la /nix/var/nix/profiles/ || echo "profiles dir does not exist"
          echo ""
          echo "=== /nix/var/nix/profiles/default contents ==="
          ls -la /nix/var/nix/profiles/default/ || echo "default profile does not exist"
          echo ""
          echo "=== Looking for nix-daemon.sh anywhere in /nix ==="
          find /nix -name "nix-daemon.sh" 2>/dev/null || echo "nix-daemon.sh not found"
          echo ""
          echo "=== Looking for any profile.d directories ==="
          find /nix -type d -name "profile.d" 2>/dev/null || echo "No profile.d directories"
          echo ""
          echo "=== /nix/receipt.json contents ==="
          cat /nix/receipt.json 2>/dev/null | head -50 || echo "receipt.json does not exist"

      # Install Nix on host to prepare shared Nix store
      # Skip if cache was restored (Nix is already available from cache)
      - name: Install Nix
        if: steps.nix-cache.outputs.hit != 'true'
        uses: DeterminateSystems/nix-installer-action@main

      # DEBUG: Inspect /nix directory after fresh Nix install
      - name: Debug - Inspect /nix after fresh install
        if: steps.nix-cache.outputs.hit != 'true'
        run: |
          echo "=== Fresh install debug info ==="
          echo ""
          echo "=== /nix/var/nix/profiles contents ==="
          ls -la /nix/var/nix/profiles/ || echo "profiles dir does not exist"
          echo ""
          echo "=== /nix/var/nix/profiles/default contents ==="
          ls -la /nix/var/nix/profiles/default/ || echo "default profile does not exist"
          echo ""
          echo "=== Looking for nix-daemon.sh anywhere in /nix ==="
          find /nix -name "nix-daemon.sh" 2>/dev/null || echo "nix-daemon.sh not found"
          echo ""
          echo "=== /nix/receipt.json contents ==="
          cat /nix/receipt.json 2>/dev/null | head -50 || echo "receipt.json does not exist"

      # Source Nix profile when using cached Nix (not installed fresh)
      # Falls back to fresh install if cache is corrupted
      - name: Setup Nix from cache
        id: setup-cached-nix
        if: steps.nix-cache.outputs.hit == 'true'
        run: |
          if [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ]; then
            echo "Using Nix from cache"
            . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
            echo "/nix/var/nix/profiles/default/bin" >> $GITHUB_PATH
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "::warning::Cache appears corrupted, falling back to fresh install"
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      # Fallback: Install Nix if cached setup failed
      - name: Install Nix (fallback)
        if: steps.nix-cache.outputs.hit == 'true' && steps.setup-cached-nix.outputs.success != 'true'
        uses: DeterminateSystems/nix-installer-action@main

      # DEBUG: Inspect /nix after fallback install
      - name: Debug - Inspect /nix after fallback install
        if: steps.nix-cache.outputs.hit == 'true' && steps.setup-cached-nix.outputs.success != 'true'
        run: |
          echo "=== Fallback install debug info ==="
          echo ""
          echo "=== /nix/var/nix/profiles/default contents ==="
          ls -la /nix/var/nix/profiles/default/ || echo "default profile does not exist"
          echo ""
          echo "=== Looking for nix-daemon.sh anywhere in /nix ==="
          find /nix -name "nix-daemon.sh" 2>/dev/null || echo "nix-daemon.sh not found"

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Docker image
        run: docker pull ghcr.io/${{ github.repository }}/dotfiles-env:latest

      # Build and verify inside container with host's Nix store mounted
      # Runs as archie user to match Home Manager configuration
      # Executes activation to fully test the deployment process
      - name: Build and verify Home Manager configuration in container
        run: |
          docker run --rm \
            -v "${{ github.workspace }}:/workspace" \
            -v "/nix:/nix" \
            -w /workspace \
            ghcr.io/${{ github.repository }}/dotfiles-env:latest \
            bash -c '
              git config --global --add safe.directory /workspace
              nix build .#homeConfigurations.archie.activationPackage
              echo "=== Verifying build output ==="
              ls -la ./result/
              echo "=== Running Home Manager activation ==="
              ./result/activate
              echo "=== Home Manager activation completed successfully ==="
            '
