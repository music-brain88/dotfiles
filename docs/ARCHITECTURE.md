# Architecture / ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§ã¯ã€dotfilesãƒªãƒã‚¸ãƒˆãƒªã®è¨­è¨ˆæ€æƒ³ã¨ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

---

## ğŸ“š Table of Contents

- [Design Philosophy](#design-philosophy)
- [Hybrid Approach](#hybrid-approach)
- [Module Structure](#module-structure)
- [Configuration Strategies](#configuration-strategies)
- [CI/CD Architecture](#cicd-architecture)

---

## ğŸ¯ Design Philosophy

### Core Principles

1. **Simplicityï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã•ï¼‰**: Arch Linuxã®å“²å­¦ã«å€£ã„ã€è¨­å®šã‚„æ§‹æˆã‚’å¯èƒ½ãªé™ã‚Šã‚·ãƒ³ãƒ—ãƒ«ã«ä¿ã¤ã€‚ä¸è¦ãªè¤‡é›‘ã•ã‚’é¿ã‘ã€å¿…è¦æœ€å°é™ã®è¨­å®šã§æœ€å¤§é™ã®åŠ¹æœã‚’å¾—ã‚‹
2. **Reproducibilityï¼ˆå†ç¾æ€§ï¼‰**: ã©ã®ãƒã‚·ãƒ³ã§ã‚‚åŒã˜ç’°å¢ƒã‚’æ§‹ç¯‰å¯èƒ½ã€‚GitHub Actionsã‚„Dockerã‚’æ´»ç”¨ã—ã€ç’°å¢ƒæ§‹ç¯‰ã‚’è‡ªå‹•åŒ–ãƒ»æ¨™æº–åŒ–ã™ã‚‹
3. **Efficiencyï¼ˆåŠ¹ç‡æ€§ï¼‰**: é »ç¹ã«è¡Œã†æ“ä½œã‚„ç¹°ã‚Šè¿”ã—ä½œæ¥­ã‚’è‡ªå‹•åŒ–ã—ã€ä½œæ¥­åŠ¹ç‡ã‚’æœ€å¤§åŒ–ã€‚Fishã‚·ã‚§ãƒ«ã‚„skimã€Neovimã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’æ´»ç”¨
4. **Extensibilityï¼ˆæ‹¡å¼µæ€§ï¼‰**: å°†æ¥çš„ãªå¤‰æ›´ã‚„æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã®å°å…¥ã«æŸ”è»Ÿã«å¯¾å¿œã€‚ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–ã•ã‚ŒãŸè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚„ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ç®¡ç†ã‚’é€šã˜ã¦ã€å®¹æ˜“ã«æ‹¡å¼µå¯èƒ½ãªæ§‹æˆã‚’ç¶­æŒ
5. **Maintainabilityï¼ˆãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ï¼‰**: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ•´ç†ã—ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚„ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆãŒå®¹æ˜“ã«ãªã‚‹ã‚ˆã†ã«ã€‚ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ•´å‚™ã—ã€è¨­å®šã®æ„å›³ã‚„ä½¿ã„æ–¹ã‚’æ˜ç¢ºã«ã™ã‚‹
6. **Eleganceï¼ˆç¾ã—ã•ï¼‰**: Rustè¨€èªã®ã‚ˆã†ã«ã€è¨­å®šã‚„ã‚³ãƒ¼ãƒ‰ã®ç¾ã—ã•ã‚„èª­ã¿ã‚„ã™ã•ã‚’é‡è¦–ã€‚ä¸€è²«ã—ãŸã‚¹ã‚¿ã‚¤ãƒ«ã‚„ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ç¶­æŒ
7. **Declarative Managementï¼ˆå®£è¨€çš„ç®¡ç†ï¼‰**: ã€Œã©ã®ã‚ˆã†ã«ï¼ˆHowï¼‰ã€ã§ã¯ãªãã€Œä½•ã‚’ï¼ˆWhatï¼‰ã€ã‚’æ˜ç¢ºã«è¨˜è¿°ã—ã€è¨­å®šã®æ„å›³ã‚’æ˜ç¢ºã«ã—ã¦ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’å‘ä¸Šã•ã›ã‚‹

### Practical Implementation

ä¸Šè¨˜ã®è¨­è¨ˆæ€æƒ³ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªå–ã‚Šçµ„ã¿ï¼š

- **è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–**: ç”¨é€”ã‚„ãƒ„ãƒ¼ãƒ«ã”ã¨ã«ç´°ã‹ãåˆ†å‰²ã€‚Neovimã¯ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã”ã¨ã«TOMLãƒ•ã‚¡ã‚¤ãƒ«ã«åˆ†å‰²ã—ã¦dein.vimã§ç®¡ç†
- **ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®æ´»ç”¨**: dotfilesãƒªãƒã‚¸ãƒˆãƒªå†…ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ›ãƒ¼ãƒ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã—ã€ä¸€å…ƒç®¡ç†ã‚’å®Ÿç¾
- **CI/CDã«ã‚ˆã‚‹è‡ªå‹•åŒ–**: GitHub Actionsã‚’æ´»ç”¨ã—ã¦è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚„é–‹ç™ºç’°å¢ƒã®æ§‹ç¯‰ã‚’è‡ªå‹•åŒ–
- **ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ•´å‚™**: è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ„å›³ã‚„ä½¿ã„æ–¹ã‚’æ˜ç¢ºã«ã™ã‚‹ãŸã‚ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ•´å‚™
- **Rustè£½ãƒ„ãƒ¼ãƒ«ã®æ´»ç”¨**: ripgrep, fd, bat, gituiãªã©Rustè£½CLIãƒ„ãƒ¼ãƒ«ã‚’ç©æ¥µçš„ã«æ´»ç”¨ã—ã€ä½œæ¥­åŠ¹ç‡ã‚’å‘ä¸Š

### Why Nix + Symlinks?

å¾“æ¥ã®dotfilesç®¡ç†ã«ã¯2ã¤ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒãŒã‚ã‚Šã¾ã™ï¼š

| Approach | Pros | Cons |
|----------|------|------|
| **Pure Nix** | å®Œå…¨ãªå†ç¾æ€§ã€å®£è¨€çš„ | æ—¢å­˜è¨­å®šã®ç§»è¡ŒãŒå¤§å¤‰ã€å­¦ç¿’ã‚³ã‚¹ãƒˆé«˜ |
| **Pure Symlinks** | ã‚·ãƒ³ãƒ—ãƒ«ã€æŸ”è»Ÿ | ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†ãŒåˆ¥é€”å¿…è¦ã€ç’°å¢ƒå·®ç•° |

**ã“ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã¯ã€Œãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã€ã‚’æ¡ç”¨ï¼š**

```
Nix/Home Manager
â”œâ”€â”€ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆå†ç¾æ€§ï¼‰
â”œâ”€â”€ ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³å›ºå®šï¼ˆå†ç¾æ€§ï¼‰
â””â”€â”€ ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®ä½œæˆ
    â†“
æ—¢å­˜ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæŸ”è»Ÿæ€§ï¼‰
â”œâ”€â”€ .config/nvim/*.toml
â”œâ”€â”€ .config/fish/config.fish
â”œâ”€â”€ .config/hypr/keybinds.conf
â””â”€â”€ ...
```

---

## ğŸ”€ Hybrid Approach

### Nixã®å½¹å‰²

```nix
# ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®ã¿
home.packages = with pkgs; [
  fish
  starship
  # ...
];

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯
home.file.".config/fish/config.fish".source = ../../.config/fish/config.fish;
```

**NixãŒæ‹…å½“ã™ã‚‹ã‚‚ã®ï¼š**
- ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
- ä¾å­˜é–¢ä¿‚ã®è§£æ±º
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å›ºå®šï¼ˆflake.lockï¼‰
- ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã®ä½œæˆ

**NixãŒæ‹…å½“ã—ãªã„ã‚‚ã®ï¼š**
- è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä¸­èº«
- ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã®è¨­å®šï¼ˆNeovimã®dein.vimç­‰ï¼‰

### ãªãœã“ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼Ÿ

#### 1. ãƒ„ãƒ¼ãƒ«ã”ã¨ã«è¨­å®šå½¢å¼ãŒç•°ãªã‚‹

ã™ã¹ã¦ã®ãƒ„ãƒ¼ãƒ«ãŒåŒã˜è¨­å®šå½¢å¼ã«ãªã‚‹ã“ã¨ã¯ã‚ã‚Šãˆãªã„ã€‚å„ãƒ„ãƒ¼ãƒ«ã¯ç‹¬è‡ªã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã‚’æŒã£ã¦ã„ã‚‹ï¼š

| Tool | Native Config Format | Why Keep Native |
|------|---------------------|-----------------|
| Neovim (dein.vim) | TOML | dein.vimã¯TOMLå‰æã®è¨­è¨ˆ |
| Fish | `.fish` | è£œå®Œãƒ»é–¢æ•°ãŒç‹¬è‡ªå½¢å¼ |
| Starship | TOML | å…¬å¼ãŒTOMLæ¨å¥¨ |
| Hyprland | Custom DSL | Hyprç‹¬è‡ªã®ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ |
| Alacritty | TOML/YAML | å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒTOML/YAML |
| Tmux | tmux.conf | ç‹¬è‡ªã®ã‚³ãƒãƒ³ãƒ‰å½¢å¼ |

**Nixå¼ã«çµ±ä¸€ã™ã‚‹ãƒ¡ãƒªãƒƒãƒˆãŒãªã„ã€‚ã‚€ã—ã‚å„ãƒ„ãƒ¼ãƒ«ã®ãƒã‚¤ãƒ†ã‚£ãƒ–å½¢å¼ã‚’ä½¿ã†æ–¹ãŒï¼š**
- å…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒãã®ã¾ã¾ä½¿ãˆã‚‹
- ãƒ„ãƒ¼ãƒ«å›ºæœ‰ã®æ©Ÿèƒ½ï¼ˆã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã€LSPç­‰ï¼‰ãŒæ´»ç”¨ã§ãã‚‹
- è¨­å®šã®å…±æœ‰ãƒ»å‚è€ƒã«ã—ã‚„ã™ã„

#### 2. æ—¢å­˜ã®è¨­å®šã‚’æ´»ã‹ã™

Neovimã®è¨­å®šã¯13å€‹ã®TOMLãƒ•ã‚¡ã‚¤ãƒ«ã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

```
.config/nvim/
â”œâ”€â”€ dein.toml           # 200+ lines
â”œâ”€â”€ ddc_settings.toml   # 160+ lines
â”œâ”€â”€ ddu_settings.toml   # 400+ lines
â”œâ”€â”€ lsp_settings.toml   # 120+ lines
â””â”€â”€ ...
```

ã“ã‚Œã‚‰ã‚’Nixå¼ã«æ›¸ãç›´ã™ã®ã¯ï¼š
- è†¨å¤§ãªä½œæ¥­é‡
- æ—¢å­˜ã®å‹•ä½œç¢ºèªæ¸ˆã¿è¨­å®šã‚’æ¨ã¦ã‚‹ã“ã¨ã«ãªã‚‹
- dein.vimã®ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰é›¢ã‚Œã‚‹

#### 3. Nixã®å¼·ã¿ã«é›†ä¸­

Nixã¯**ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ç®¡ç†**ã¨**ç’°å¢ƒã®å†ç¾æ€§**ã«ç‰¹åŒ–ã•ã›ã‚‹ã€‚è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ç®¡ç†ã¯å„ãƒ„ãƒ¼ãƒ«ã®ãƒã‚¤ãƒ†ã‚£ãƒ–å½¢å¼ã«ä»»ã›ã‚‹ã€‚

---

## ğŸ“¦ Module Structure

### Nixãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®åˆ†é›¢

```
nix/modules/
â”œâ”€â”€ base.nix        # åŸºæœ¬ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆcurl, wget, git, cmakeï¼‰
â”œâ”€â”€ rust-tools.nix  # Rustãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ï¼ˆfd, ripgrep, eza, batï¼‰
â”œâ”€â”€ shell.nix       # ã‚·ã‚§ãƒ«é–¢é€£ï¼ˆfish, starship, pluginsï¼‰
â”œâ”€â”€ git.nix         # Gité–¢é€£ï¼ˆgit, delta, gh, copilot-cliï¼‰
â”œâ”€â”€ tmux.nix        # Tmuxé–¢é€£
â”œâ”€â”€ neovim.nix      # Neovim + LSP + formatters
â””â”€â”€ dev-tools.nix   # é–‹ç™ºãƒ„ãƒ¼ãƒ«ï¼ˆdocker, kubectl, awscliï¼‰
```

### åˆ†é›¢ã®åŸºæº–

1. **é–¢é€£æ€§**: åŒã˜ç›®çš„ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
2. **ä¾å­˜é–¢ä¿‚**: ä¾å­˜ãŒå°‘ãªã„ã‚‚ã®ã‚’å…ˆã«
3. **ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«**: ç’°å¢ƒã«ã‚ˆã£ã¦ä¸è¦ãªã‚‚ã®ã‚’åˆ†é›¢å¯èƒ½ã«

---

## âš™ï¸ Configuration Strategies

### Strategy 1: Package Only + Symlink

**ä½¿ç”¨å ´é¢**: è¨­å®šãŒè¤‡é›‘ã§ã€æ—¢å­˜ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ´»ã‹ã—ãŸã„å ´åˆ

```nix
# shell.nix
home.packages = with pkgs; [
  fish
  starship
];

# è¨­å®šã¯ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯
home.file.".config/fish/config.fish".source = ../../.config/fish/config.fish;
xdg.configFile."starship.toml".source = ../../.config/starship/starship.toml;
```

**æ¡ç”¨ä¾‹**: Fish, Neovim, Hyprland, Alacritty, Tmux

### Strategy 2: programs.* with Native Config

**ä½¿ç”¨å ´é¢**: NixãŒæä¾›ã™ã‚‹è¨­å®šã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æ´»ç”¨ã—ã¤ã¤ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯åˆ¥ç®¡ç†

```nix
# neovim.nix
programs.neovim = {
  enable = true;
  defaultEditor = true;
  viAlias = true;
  vimAlias = true;
  extraPackages = with pkgs; [
    lua-language-server
    rust-analyzer
    # ...
  ];
};
```

**ãƒã‚¤ãƒ³ãƒˆ**: `programs.neovim.enable`ã‚’ä½¿ã„ã¤ã¤ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«è‡ªä½“ã¯`home.file`ã§ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯

**æ¡ç”¨ä¾‹**: Neovimï¼ˆãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¯programs.*ã€è¨­å®šã¯symlinkï¼‰

### Strategy 3: Package Only (No Config)

**ä½¿ç”¨å ´é¢**: è¨­å®šä¸è¦ãªCLIãƒ„ãƒ¼ãƒ«

```nix
# rust-tools.nix
home.packages = with pkgs; [
  fd
  ripgrep
  eza
  bat
];
```

**æ¡ç”¨ä¾‹**: å¤§åŠã®CLIãƒ„ãƒ¼ãƒ«

---

## ğŸ”„ CI/CD Architecture

> è©³ç´°ã¯ [CICD.md](./CICD.md) ã‚’å‚ç…§ï¼ˆEvolution Historyã€Lessons Learned ç­‰ï¼‰

### Hybrid Docker + Nix Pipeline

GitHub Actionsã®ãƒ‡ã‚£ã‚¹ã‚¯å®¹é‡åˆ¶é™ï¼ˆç´„14GBï¼‰ã‚’å›é¿ã™ã‚‹ãŸã‚ã€NixãŒãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸ Docker ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½¿ç”¨ã€‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GitHub Actions (nix.yml)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚ build-image â”‚     â”‚    check    â”‚               â”‚
â”‚  â”‚             â”‚     â”‚             â”‚               â”‚
â”‚  â”‚ Docker imageâ”‚     â”‚ flake check â”‚  â† ä¸¦åˆ—å®Ÿè¡Œ   â”‚
â”‚  â”‚ build/push  â”‚     â”‚ format checkâ”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚         â”‚                   â”‚                       â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                   â–¼                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â”‚  verify-docker  â”‚                        â”‚
â”‚         â”‚                 â”‚                        â”‚
â”‚         â”‚ Build & activateâ”‚                        â”‚
â”‚         â”‚ in Arch Linux   â”‚                        â”‚
â”‚         â”‚ container       â”‚                        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Pipeline Stages

| Stage | Purpose |
|-------|---------|
| **build-image** | Docker ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦GHCRã«ãƒ—ãƒƒã‚·ãƒ¥ |
| **check** | `nix flake check --no-build`ã€ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¤œè¨¼ |
| **verify-docker** | Arch Linux ã‚³ãƒ³ãƒ†ãƒŠå†…ã§ãƒ“ãƒ«ãƒ‰ï¼†ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ |

### Caching Strategy

| Layer | Tool | Purpose |
|-------|------|---------|
| Docker | `type=gha` layer cache | Nix installation, base setup |
| Nix (check) | `magic-nix-cache` | è»½é‡ãƒã‚§ãƒƒã‚¯ç”¨ |
| Nix (verify) | `cache-nix-action` | Dockerå†…ãƒ“ãƒ«ãƒ‰ç”¨ |

**Note**: `magic-nix-cache` ã¯Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§ã¯å‹•ä½œã—ãªã„ï¼ˆNix daemonã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­æ–¹å¼ã®ãŸã‚ï¼‰ã€‚
è©³ç´°ã¯ [CICD.md - Phase 3](./CICD.md#phase-3-magic-nix-cache-ã®é™ç•Œ-216) ã‚’å‚ç…§ã€‚

---

## ğŸ“Š Decision Matrix

æ–°ã—ã„ãƒ„ãƒ¼ãƒ«ã‚’è¿½åŠ ã™ã‚‹éš›ã®åˆ¤æ–­åŸºæº–ï¼š

| Question | Yes â†’ | No â†’ |
|----------|-------|------|
| è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãŒè¤‡é›‘ï¼Ÿ | Symlink | Package Only |
| æ—¢å­˜ã®è¨­å®šãŒã‚ã‚‹ï¼Ÿ | Symlink | programs.* or Package Only |
| ãƒ„ãƒ¼ãƒ«å›ºæœ‰ã®DSL/å½¢å¼ï¼Ÿ | Symlinkï¼ˆãƒã‚¤ãƒ†ã‚£ãƒ–å½¢å¼ã‚’æ´»ç”¨ï¼‰ | - |
| è¨­å®šä¸è¦ãªCLIï¼Ÿ | Package Only | - |

---

## ğŸ”— Related Documentation

- [CICD.md](./CICD.md) - CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³è©³ç´°ã€Evolution History
- [NIX.md](./NIX.md) - Nix/Home Manager ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰
- [STRUCTURE.md](./STRUCTURE.md) - ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
- [WORKFLOW.md](./WORKFLOW.md) - ä½œæ¥­ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
- [CLAUDE.md](../CLAUDE.md) - Claude Codeå‘ã‘ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ

---

**ã“ã®è¨­è¨ˆã«ã‚ˆã‚Šã€Nixã®å†ç¾æ€§ã¨å„ãƒ„ãƒ¼ãƒ«ã®ãƒã‚¤ãƒ†ã‚£ãƒ–è¨­å®šå½¢å¼ã®æŸ”è»Ÿæ€§ã‚’ä¸¡ç«‹ã—ã¦ã„ã¾ã™ã€‚** ğŸ‰
